workflows:
  android-apk-free:
    name: Android APK Build
    environment:
      groups:
        - keystore
      vars:
        BUNDLE: "false"
        CM_GH_TOKEN: "${CM_GH_TOKEN:-TOKTOKTOK}"
    scripts:
      - name: Setup and Build
        script: |
          flutter packages pub get
          
          # Decode keystore if available
          if [ -f "android/keystore.base64" ]; then
            echo "üîê Decoding keystore from base64..."
            base64 -d android/keystore.base64 > android/app/mahakka.keystore
          fi
      
          # Set signing environment variables for Gradle
          if [ -f "android/app/mahakka.keystore" ] && [ -n "$CM_KEYSTORE_PASSWORD" ]; then
            echo "üîê Configuring signing for release build..."
            export STORE_FILE="mahakka.keystore"
            export STORE_PASSWORD="$CM_KEYSTORE_PASSWORD"
            export KEY_ALIAS="mahakka"
            export KEY_PASSWORD="${CM_KEY_PASSWORD:-$CM_KEYSTORE_PASSWORD}"
          else
            echo "‚ö†Ô∏è Building unsigned APK (no keystore or password)"
            # Clear any previous signing environment variables
            unset STORE_FILE
            unset STORE_PASSWORD
            unset KEY_ALIAS
            unset KEY_PASSWORD
          fi
      
          # Build release APK - Gradle will automatically use the environment variables
          echo "üèóÔ∏è Building APK..."
          flutter build apk --release

      - name: Create GitHub Release with curl
        script: |
          # Create GitHub release using curl (no gh CLI needed)
          APK_FILE=$(find build/app/outputs/flutter-apk -name "*.apk" | head -n 1)
          
          if [ -z "$APK_FILE" ]; then
            echo "‚ùå No APK file found for release!"
            exit 1
          fi
          
          echo "üì¶ Creating GitHub release for: $APK_FILE"
          
          # Auto-detect repository from git remote
          AUTO_REPO=$(git remote -v | head -n 1 | sed -E 's/.*github.com[:\/]([^\.]+).*/\1/')
          
          # Use override repo if provided, otherwise auto-detect
          TARGET_REPO="${GH_REPO:-$AUTO_REPO}"
          
          if [ -z "$TARGET_REPO" ]; then
            echo "‚ùå Could not determine GitHub repository"
            echo "   Either set GH_REPO environment variable or ensure git remote is configured"
            exit 1
          fi
          
          echo "üè∑Ô∏è  Target repository: $TARGET_REPO"
          
          # Get GitHub token (use provided token or try CodeMagic's token)
          GITHUB_TOKEN="$CM_GH_TOKEN"
          
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "‚ùå GitHub token is required for creating releases with curl"
            echo "   Please set CM_GH_TOKEN environment variable in CodeMagic"
            exit 1
          fi
          
          # Define a fallback for the CM_BUILD_NUMBER
          CM_BUILD_NUMBER=${CM_BUILD_NUMBER:-$(date +%Y%m%d%H%M%S)}
          
          APK_NAME=$(basename "$APK_FILE")
          RELEASE_TAG="v$CM_BUILD_NUMBER"
          RELEASE_NAME="Release v$CM_BUILD_NUMBER"
          
          # Create release
          echo "üöÄ Creating release $RELEASE_TAG..."
          RELEASE_RESPONSE=$(curl -s -w "%{http_code}" -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/$TARGET_REPO/releases" \
            -d "{
              \"tag_name\": \"$RELEASE_TAG\",
              \"name\": \"$RELEASE_NAME\",
              \"body\": \"Automated build from CodeMagic\\n- Build Number: $CM_BUILD_NUMBER\\n- Commit: $(git log -1 --pretty=%B | head -n 1)\\n- Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')\",
              \"draft\": false,
              \"prerelease\": false
            }")
          
          # Extract HTTP status code and response body
          HTTP_STATUS=${RELEASE_RESPONSE: -3}
          RESPONSE_BODY=${RELEASE_RESPONSE%???}
          
          if [ "$HTTP_STATUS" -ne 201 ]; then
            echo "‚ùå Failed to create release (HTTP $HTTP_STATUS)"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi
          
          UPLOAD_URL=$(echo "$RESPONSE_BODY" | grep -o '"upload_url": "[^"]*' | cut -d'"' -f4 | sed 's/{.*}//')
          RELEASE_ID=$(echo "$RESPONSE_BODY" | grep -o '"id": [0-9]*' | cut -d' ' -f2)
          
          if [ -z "$UPLOAD_URL" ] || [ -z "$RELEASE_ID" ]; then
            echo "‚ùå Failed to parse release response"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi
          
          echo "‚úÖ Release created successfully (ID: $RELEASE_ID)"
          
          # Upload APK asset
          echo "üì§ Uploading APK asset..."
          UPLOAD_RESPONSE=$(curl -s -w "%{http_code}" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/vnd.android.package-archive" \
            --data-binary "@$APK_FILE" \
            "$UPLOAD_URL?name=$APK_NAME")
          
          UPLOAD_STATUS=${UPLOAD_RESPONSE: -3}
          UPLOAD_BODY=${UPLOAD_RESPONSE%???}
          
          if [ "$UPLOAD_STATUS" -ne 201 ]; then
            echo "‚ùå Failed to upload asset (HTTP $UPLOAD_STATUS)"
            echo "Response: $UPLOAD_BODY"
            exit 1
          fi
          
          DOWNLOAD_URL=$(echo "$UPLOAD_BODY" | grep -o '"browser_download_url": "[^"]*' | cut -d'"' -f4)
          
          if [ -n "$DOWNLOAD_URL" ]; then
            echo "‚úÖ Release created successfully!"
            echo "üì• Download URL: $DOWNLOAD_URL"
          else
            echo "‚ö†Ô∏è  Release created but could not get download URL"
            echo "Release page: https://github.com/$TARGET_REPO/releases/tag/$RELEASE_TAG"
          fi

    artifacts:
      - build/app/outputs/flutter-apk/*.apk

    publishing:
      email:
        recipients:
          - bitcoinizado@proton.me
        notify:
          success: true
          failure: true